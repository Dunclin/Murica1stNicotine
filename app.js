const CART_KEY='zyn_cart_v1';const addrInput=document.getElementById('addr');const routeMiEl=document.getElementById('route-mi');const feeDeliveryEl=document.getElementById('fee-delivery');const feeGasEl=document.getElementById('fee-gas');const grandTotalEl=document.getElementById('grand-total');const quoteBtn=document.getElementById('quote');const quoteStatus=document.getElementById('quote-status');let lMap,lRouter,shopLatLng,destLatLng,lastQuote;function init(){lMap=L.map('map').setView([39.7597,-76.6760],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(lMap);const provider=L.Control.Geocoder.nominatim();provider.geocode(window.SHOP_ADDRESS,(results)=>{if(results&&results.length){const c=results[0].center;shopLatLng={lat:c.lat,lng:c.lng};L.marker([c.lat,c.lng]).addTo(lMap).bindPopup('Shop');lMap.setView([c.lat,c.lng],13);}});const g=L.Control.geocoder({defaultMarkGeocode:false}).addTo(lMap);g.on('markgeocode',(e)=>{const c=e.geocode.center;destLatLng={lat:c.lat,lng:c.lng};L.marker([c.lat,c.lng]).addTo(lMap);drawRoute();quoteStatus.textContent='Click "Get delivery quote" to compute fees.';});lMap.on('click',(e)=>{destLatLng={lat:e.latlng.lat,lng:e.latlng.lng};L.marker([destLatLng.lat,destLatLng.lng]).addTo(lMap);drawRoute();quoteStatus.textContent='Click "Get delivery quote" to compute fees.';});}function drawRoute(){if(!shopLatLng||!destLatLng)return;if(lRouter){lMap.removeControl(lRouter);lRouter=null;}lRouter=L.Routing.control({waypoints:[L.latLng(shopLatLng.lat,shopLatLng.lng),L.latLng(destLatLng.lat,destLatLng.lng)],router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),addWaypoints:false,draggableWaypoints:false,show:false,fitSelectedRoutes:true}).on('routesfound',(e)=>{const meters=e.routes[0].summary.totalDistance;const miles=meters/1609.344;routeMiEl.textContent=miles.toFixed(2);}).addTo(lMap);}async function requestQuote(){const address=(addrInput?.value||'').trim();if(!address&&!destLatLng){alert('Enter or pick a delivery address.');return;}quoteStatus.textContent='Calculatingâ€¦';try{const res=await fetch(`${window.API_BASE}/api/quote`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address,lat:destLatLng?.lat,lng:destLatLng?.lng})});if(!res.ok)throw new Error('Quote failed');const data=await res.json();lastQuote=data;feeDeliveryEl.textContent=data.fees.delivery.toFixed(2);feeGasEl.textContent=data.fees.gas.toFixed(2);const cartTotal=0;grandTotalEl.textContent=(cartTotal+data.fees.delivery+data.fees.gas).toFixed(2);quoteStatus.textContent='Quote updated.';}catch(e){console.error(e);quoteStatus.textContent='Could not calculate.';}}document.addEventListener('DOMContentLoaded',init);quoteBtn?.addEventListener('click',requestQuote);